# Matching index and web services

This module of the `backend` repository provides a tool for generating a Lucene search index for a taxonomy,
along with a set of web services that utilize these indexes. The primary purpose of these indexes and 
web services is to match scientific names and classifications, typically derived from occurrence and event datasets.

## Dependencies

The matching index and web services depend on:

* Java 11
* Maven 3.x
* Lucene 9.x
* Spring Boot 2.x

## Generating an index

The data input for generating these Lucene indexes is a set of name usages, typically extracted from the ChecklistBank database. 
However, the index can also be generated from a CSV file with the following columns:

* `id` - an identifier for the name usage, which is unique within this CSV
* `parentID` - an identifier for the parent name usage
* `scientificName` - the canonical scientific name, without authorship
* `authorship` - the authorship for this name usage
* `rank` - the taxonomic rank e.g. GENUS. See the [Rank](https://github.com/gbif/name-parser/blob/master/name-parser-api/src/main/java/org/gbif/nameparser/api/Rank.java) enumeration for a list of recognised values.
* `status` - the taxonomic status of the usage e.g. ACCEPTED, SYNONYM. See the [TaxonomicStatus](../api/src/main/java/life/catalogue/api/vocab/TaxonomicStatus.java) enumeration for a list of recognised values.
* `nomenclaturalCode` - the nomenclatural code for this usage e.g. ZOOLOGICAL. See the [NomCode](https://github.com/gbif/name-parser/blob/master/name-parser-api/src/main/java/org/gbif/nameparser/api/NomCode.java) enumeration for a list of recognised values.

### Generating an index from ChecklistBank database

To generate an index by connecting to an instance of the ChecklistBank database:

```bash
java -jar matching-ws.jar \ 
  --mode=BUILD_INDEX \
  --clb.dataset.id=3LXRC \
  --clb.dataset.username=***** \  
  --clb.dataset.password=***** \
  --index.path=/data/matching-ws/index \
  --export.path=/data/matching-ws/export
```

### Generating using a pre-existing CSV

To generate an index from a CSV of name usages:

```bash
java -jar matching-ws.jar \ 
  --mode=INDEX_CSV \
  --index.path=/data/matching-ws/index \
  --export.path=/data/matching-ws/export/
```
where the directory `/data/matching-ws/export/` contains a `index.csv` file containing all the name usages
for this index.

## Building this library as an executable Jar file

The matching index and web services are implemented in Java 17, using Spring Boot 3.x.
An executable jar file can be generated by running the following command:

```bash
mvn clean install spring-boot:repackage
```

## Building docker images

### Software only
To build a software only docker image, run the following command from the root directory of this module (backend/matching-ws):
```bash
docker buildx build --platform linux/amd64 . -t matching-ws:1.0-SNAPSHOT
```
For this image to be of use, a lucene index must be pre-generated and mounted as a docker
volume with the docker container.


### Software and index generation with ChecklistBank
To build a docker image, and generate a lucene index as part of the build, run the following command:
```bash
docker buildx build \
--platform linux/amd64 . -t matching-ws:v1 \
--build-arg CLB_DATASET_ID=3LXRC \
--build-arg CLB_URL=http://api.checklistbank.org \
--build-arg CLB_USER=*** \
--build-arg CLB_PASSWORD=****
```

### Software and index generation with existing CSV
To build a docker image, and generate a lucene index as part of the build, run the following command:
```bash
docker buildx build \
--platform linux/amd64 . -t matching-ws:v1 \
--build-arg INDEX_CSV_PATH=/data/matching-ws/export \
--build-arg CLB_URL=http://api.checklistbank.org \
--build-arg CLB_USER=*** \
--build-arg CLB_PASSWORD=****
```

### Local docker builds for development purposes

For local development, the following command can be used to build a docker image.
Run this from the root of the cloned copy of the `backend` repository:
```bash
docker build -f matching-ws/Dockerfile-local . -t matching-local-build
```

To use this locally built image, run the following command:
```bash
docker run \
--name matching-ws-local \
--volume=/Users/me/local-index-build/matching-ws:/data/matching-ws \
--network=bridge \
-p 8181:8080 \
-d \
matching-local-build:latest
```


## Running docker image

Pre-built Docker images can be pulled from the Docker repository at docker.gbif.org and run as follows:
```bash
docker pull docker.gbif.org/matching-ws:1.0-SNAPSHOT-3LXRC
docker run  -d --platform linux/arm64 -p 8080:8080 \
--name matching-ws-3LXRC \
matching-ws:1.0-SNAPSHOT-3LXRC  docker.gbif.org
```

### Indexing additional identifier & IUCN status 

Indexes can be generated from checklistbank that include additional sources of taxon identifiers (e.g. LSIDs)
that may be provided in occurrence records using the darwin core fields  `taxonID`, `taxonConceptID` and `scientificNameID`.

```bash
docker buildx build \
--platform linux/amd64 . -t matching-ws:v1 \
--build-arg CLB_DATASET_ID=3LXRC \
--build-arg CLB_IUCN_DATASET_ID=53131 \
--build-arg CLB_IDENTIFIER_DATASET_IDS=2011,2006,7888 \
--build-arg CLB_URL=http://api.checklistbank.org \
--build-arg CLB_USER=*** \
--build-arg CLB_PASSWORD=****
```
Where in this example `53131` is the key for the IUCN dataset in checklistbank.

## Implementation notes

Generated indexes are split into 3 directories, under the main index directory 
(typically `/data/matching-ws/index`)
* `/main` - the main index for the checklist/dataset
* `/identifiers` - contains 0..n identifier indexes, allowing the matching of LSID for recognised persistent identifiers
* `/ancillary` - contains 0..n ancillary indexes, providing status information associated with name usages e.g. IUCN

The index generation tool generates the index and a `metadata.json`
in the index directory. The JSON contains some statistics on the generated index.

```json
{
  "key": 289237,
  "title": "Catalogue of Life Checklist",
  "alias": "COL-2024-04-22",
  "taxonCount": 6766516
}
```

Similarly, for identifier indexes:
```json
{
  "key": 2011,
  "gbifKey": "2d59e5db-57ad-41ff-97d6-11f5fb264527",
  "title": "World Register of Marine Species",
  "alias": "WoRMS",
  "taxonCount": 1378897,
  "matchesToMainIndex": 1364002
}
```
The `matchesToMainIndex` field gives a count of the taxa that have been associated with the main index.


## Identifier prefix mapping 

The file `datasets.json` contains some mappings for recognised prefixes for persistent identifiers
allowing the mapping of strings such as `http://marinespecies.org/data.php?id=123` to the recognised
persistent identifier format e.g. `urn:lsid:marinespecies.org:taxname:123`

```json
{
  "key": "2011",
  "gbifKey": "2d59e5db-57ad-41ff-97d6-11f5fb264527",
  "title": "WoRMS",
  "prefix": "urn:lsid:marinespecies.org:taxname:",
  "prefixMapping": [
    "http://marinespecies.org/data.php?id=",
    "https://marinespecies.org/data.php?id=",
    "https://www.marinespecies.org/aphia.php?p=taxdetails&id="
  ]
}
```
